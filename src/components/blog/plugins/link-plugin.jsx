import { useLexicalComposerContext } from "@lexical/react/LexicalComposerContext";
import { useCallback, useEffect, useRef, useState } from "react";
import { toggleLink } from "@lexical/link";

export const CreateLinkPlugin = () => {
  const [editor] = useLexicalComposerContext();
  const ref = useRef();
  const [url, setUrl] = useState("");
  const [isOpen, setIsOpen] = useState(false);

  const insertLink = useCallback(() => {
    editor.update(() => {
      if (url) {
        toggleLink(url);
        setIsOpen(false);
      }
    });
  }, [url]);

  useEffect(() => {
    document.addEventListener(
      "click",
      function (e) {
        if (!ref.current?.contains(e.target)) {
          setIsOpen(false);
        }
      },
      true
    );
  }, [ref]);
  return (
    <div
      className="flexer-box plugin-box "
      style={{
        cursor: "pointer",
        position: "relative",
      }}
    >
      <svg
        width="24"
        height="24"
        onClick={() => setIsOpen((prev) => !prev)}
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12.7835 17.5809C12.8884 17.6854 12.9716 17.8096 13.0284 17.9463C13.0852 18.0831 13.1144 18.2297 13.1144 18.3777C13.1144 18.5258 13.0852 18.6724 13.0284 18.8092C12.9716 18.9459 12.8884 19.0701 12.7835 19.1746L12.2266 19.7315C11.1714 20.7867 9.74022 21.3795 8.2479 21.3795C6.75558 21.3795 5.32438 20.7867 4.26915 19.7315C3.21392 18.6762 2.62109 17.2451 2.62109 15.7527C2.62109 14.2604 3.21392 12.8292 4.26915 11.774L6.5304 9.51367C7.54429 8.49727 8.90844 7.907 10.3434 7.86378C11.7784 7.82055 13.1756 8.32764 14.2488 9.28117C14.3596 9.37966 14.45 9.49901 14.5146 9.63241C14.5793 9.7658 14.6171 9.91063 14.6258 10.0586C14.6345 10.2066 14.614 10.3549 14.5654 10.4949C14.5168 10.635 14.4411 10.7641 14.3426 10.8749C14.2441 10.9857 14.1247 11.076 13.9913 11.1407C13.8579 11.2054 13.7131 11.2432 13.5651 11.2519C13.4171 11.2606 13.2689 11.24 13.1288 11.1915C12.9888 11.1429 12.8596 11.0672 12.7488 10.9687C12.1053 10.3971 11.2676 10.093 10.4073 10.1186C9.54689 10.1443 8.72883 10.4976 8.1204 11.1065L5.86102 13.364C5.22798 13.997 4.87235 14.8556 4.87234 15.7509C4.87235 16.6461 5.22798 17.5047 5.86102 18.1377C6.49406 18.7708 7.35264 19.1264 8.2479 19.1264C9.14315 19.1264 10.0017 18.7708 10.6348 18.1377L11.1916 17.5809C11.2961 17.4763 11.4202 17.3933 11.5568 17.3367C11.6933 17.28 11.8397 17.2509 11.9876 17.2509C12.1354 17.2509 12.2818 17.28 12.4184 17.3367C12.555 17.3933 12.679 17.4763 12.7835 17.5809ZM19.7285 4.26836C18.6724 3.21475 17.2416 2.62305 15.7498 2.62305C14.258 2.62305 12.8271 3.21475 11.771 4.26836L11.2141 4.82523C11.0028 5.03658 10.8841 5.32322 10.8841 5.62211C10.8841 5.92099 11.0028 6.20764 11.2141 6.41898C11.4255 6.63033 11.7121 6.74906 12.011 6.74906C12.3099 6.74906 12.5966 6.63033 12.8079 6.41898L13.3648 5.86211C13.9978 5.22907 14.8564 4.87343 15.7516 4.87343C16.6469 4.87343 17.5055 5.22907 18.1385 5.86211C18.7716 6.49514 19.1272 7.35373 19.1272 8.24898C19.1272 9.14423 18.7716 10.0028 18.1385 10.6359L15.8782 12.8971C15.2692 13.5057 14.4507 13.8586 13.5901 13.8835C12.7296 13.9084 11.892 13.6035 11.2488 13.0312C11.138 12.9327 11.0089 12.857 10.8689 12.8084C10.7288 12.7598 10.5805 12.7393 10.4325 12.748C10.2845 12.7567 10.1397 12.7944 10.0063 12.8591C9.87293 12.9238 9.75357 13.0141 9.65508 13.1249C9.55659 13.2357 9.48089 13.3648 9.4323 13.5049C9.38371 13.645 9.36318 13.7932 9.37188 13.9412C9.38059 14.0892 9.41836 14.234 9.48303 14.3674C9.54771 14.5008 9.63803 14.6202 9.74883 14.7187C10.8213 15.672 12.2176 16.1794 13.6519 16.137C15.0862 16.0947 16.4501 15.5058 17.4645 14.4909L19.7257 12.2305C20.7805 11.1747 21.3733 9.74344 21.3738 8.25097C21.3744 6.7585 20.7826 5.32681 19.7285 4.27023V4.26836Z"
          fill="#161616"
        />
      </svg>
      {isOpen && (
        <div ref={ref} className="drop-down-toolbar">
          <input
            onChange={(event) => setUrl(event.target.value)}
            placeholder="enter link"
          />
          <button onClick={insertLink}>Add</button>
        </div>
      )}
    </div>
  );
};
